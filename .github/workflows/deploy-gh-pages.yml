name: Deploy to gh-pages branch

on:
  push:
    branches: [main]
    paths:
      - 'tools/flasher/**'
      - '.github/workflows/deploy-gh-pages.yml'
  workflow_run:
    workflows: ['Build and Release Firmware']
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest release and prepare publish dir
        env:
          REPO: SeanChangX/QBIT
        run: |
          set -e
          API="https://api.github.com/repos/${REPO}/releases/latest"
          echo "Fetching latest release..."
          RELEASE_JSON=$(curl -sL "$API")
          TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "No release found"
            exit 1
          fi
          echo "Latest release: $TAG"

          DIR=tools/flasher
          LATEST_JSON_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "latest.json") | .browser_download_url')
          if [ -z "$LATEST_JSON_URL" ] || [ "$LATEST_JSON_URL" = "null" ]; then
            echo "latest.json not in release assets"
            exit 1
          fi
          curl -sL -o "$DIR/latest.json" "$LATEST_JSON_URL"

          for name in firmware.bin littlefs.bin bootloader.bin partitions.bin; do
            URL=$(echo "$RELEASE_JSON" | jq -r --arg n "$name" '.assets[] | select(.name == $n) | .browser_download_url')
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              echo "Downloading $name..."
              curl -sL -o "$DIR/$name" "$URL"
            fi
          done

          PUBLISHED_AT=$(echo "$RELEASE_JSON" | jq -r '.published_at // empty')
          export PUBLISHED_AT
          echo "Rewriting latest.json and generating manifest.json..."
          python3 << 'PY'
          import json
          import os

          with open("tools/flasher/latest.json") as f:
              data = json.load(f)
          if not data.get("timestamp") and os.environ.get("PUBLISHED_AT"):
              data["timestamp"] = os.environ.get("PUBLISHED_AT")
          for key in data.get("files", {}):
              data["files"][key]["url"] = key
          with open("tools/flasher/latest.json", "w") as f:
              json.dump(data, f, indent=2)

          # Generate manifest.json for esp-web-tools
          # Offsets from firmware/partitions.csv
          flash_map = {
              "bootloader.bin": 0x0,
              "partitions.bin": 0x8000,
              "firmware.bin":   0x10000,
              "littlefs.bin":   0x190000,
          }
          parts = []
          for name, offset in flash_map.items():
              if name in data.get("files", {}):
                  parts.append({"path": name, "offset": offset})

          manifest = {
              "name": "QBIT",
              "version": data.get("version", "unknown"),
              "new_install_prompt_erase": True,
              "builds": [
                  {
                      "chipFamily": "ESP32-C3",
                      "parts": parts,
                  }
              ]
          }
          with open("tools/flasher/manifest.json", "w") as f:
              json.dump(manifest, f, indent=2)
          print("manifest.json generated")
          PY
          echo "Publish dir ready:"
          ls -la "$DIR"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tools/flasher
          publish_branch: gh-pages
          force_orphan: true
